# User Feedback System PRD

**Status:** Active PRD — Implementation in progress (lesson 5.4)  
**Last Updated:** 2025-02-06

---

## Overview

The User Feedback System connects the app's feedback form to n8n for AI-powered analysis and storage. Users can submit feedback from anywhere in the app, and the system automatically analyzes sentiment, categorizes feedback, assigns priority, and stores enriched data in Supabase.

**Why this matters:** Automated feedback processing enables faster response times, better prioritization, and data-driven product decisions.

---

## User Flow

Step-by-step flow from user perspective:

1. User clicks "Give Feedback" link in header
2. Modal opens with feedback form (single textarea field)
3. User fills in message textarea (required field)
4. User clicks "Send Feedback" button
5. Loading state shows "Sending…"
6. Success message appears: "Thank you for your feedback!"
7. Modal closes automatically after 2 seconds

**Edge cases:**
- Empty submission → validation error shown
- Network error → user-friendly error message
- User not authenticated → feedback still accepted (userId optional)

---

## Technical Flow

System-level flow:

1. **Frontend form submits to Server Action** (`submitFeedback`)
2. **Server Action validates data** and extracts user info from Clerk session
3. **Server Action calls n8n webhook** with complete payload
4. **n8n receives data** via Webhook Trigger (replacing Chat Trigger from lesson 5.2)
5. **n8n AI Agent processes feedback** with OpenRouter
6. **n8n Structured Output Parser** extracts JSON (sentiment, category, priority, summary, actionable)
7. **n8n Auto-fixing Output Parser** corrects any JSON errors
8. **n8n sends Gmail notification** with AI analysis
9. **n8n HTTP Request node** calls app webhook with enriched data
10. **App webhook endpoint** receives processed feedback
11. **App stores feedback in Supabase** `feedback` table

---

## Webhook Payload (App → n8n)

Exact structure of data sent to n8n:

```json
{
  "userId": "user_2abc123def",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "message": "User's feedback description text",
  "browser": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...",
  "timestamp": "2025-10-28T10:00:00Z",
  "url": "https://yourdomain.com/workspace"
}
```

**Field notes:**
- `userId`: Clerk user ID (optional if user not authenticated)
- `firstName`, `lastName`, `email`: From Clerk user object (optional if not authenticated)
- `message`: Required, from form textarea
- `browser`: User-Agent header from request
- `timestamp`: ISO 8601 format, current time
- `url`: Referer header or current page URL

**Note:** We removed "feedbackType" since the AI Agent categorizes feedback automatically.

---

## Webhook Payload (n8n → App)

Exact structure of data received from n8n (original data + AI analysis):

```json
{
  "userId": "user_2abc123def",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "message": "User's feedback description text",
  "browser": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...",
  "timestamp": "2025-10-28T10:00:00Z",
  "url": "https://yourdomain.com/workspace",
  "sentiment": "positive",
  "category": "bug",
  "priority": "high",
  "summary": "One sentence summary generated by AI",
  "actionable": true,
  "processedAt": "2025-10-28T10:00:03Z"
}
```

**AI Analysis fields:**
- `sentiment`: "positive" | "negative" | "neutral"
- `category`: "bug" | "feature_request" | "question" | "other"
- `priority`: "low" | "medium" | "high"
- `summary`: One sentence summary of the feedback
- `actionable`: Boolean indicating if feedback requires action
- `processedAt`: ISO 8601 timestamp when AI processing completed

---

## Database Schema (Supabase)

**Table:** `feedback`

**Columns:**

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | uuid | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique identifier |
| `user_id` | text | NULLABLE | Clerk user ID (references auth.users.id conceptually) |
| `first_name` | text | NOT NULL | User's first name |
| `last_name` | text | NOT NULL | User's last name |
| `email` | text | NULLABLE | User's email address |
| `message` | text | NOT NULL | Feedback message content |
| `browser` | text | NULLABLE | User-Agent string |
| `url` | text | NULLABLE | Page URL where feedback was submitted |
| `sentiment` | text | NULLABLE | AI analysis: positive/negative/neutral |
| `category` | text | NULLABLE | AI analysis: bug/feature_request/question/other |
| `priority` | text | NULLABLE | AI analysis: low/medium/high |
| `summary` | text | NULLABLE | AI-generated summary |
| `actionable` | boolean | NULLABLE | AI analysis: requires action |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | When feedback was submitted |
| `processed_at` | timestamptz | NULLABLE | When AI processing completed |

**Note:** We removed the "type" column since the AI Agent provides "category" automatically.

**RLS Policies:**

- **Users can INSERT their own feedback:** `user_id = auth.jwt()->>'sub'` OR `user_id IS NULL` (for unauthenticated feedback)
- **Admins can SELECT all feedback:** Check for admin role in metadata (future enhancement)
- **No UPDATE or DELETE permissions:** Feedback is immutable once stored

---

## Expected API Responses

### Server Action (feedback submission)

**Success:**
```json
{
  "success": true,
  "message": "Feedback submitted successfully"
}
```

**Validation Error:**
```json
{
  "success": false,
  "error": "Please enter at least one character"
}
```

**Server Error:**
```json
{
  "success": false,
  "error": "Failed to send feedback. Please try again."
}
```

### Webhook Endpoint (n8n → app)

**Success:**
```json
{
  "success": true,
  "message": "Feedback stored"
}
```

**Invalid Payload:**
```json
{
  "success": false,
  "error": "Invalid payload: missing required field 'message'"
}
```

**Database Error:**
```json
{
  "success": false,
  "error": "Database error"
}
```

**Status Codes:**
- `200`: Success
- `400`: Invalid payload
- `500`: Server error

---

## Implementation Stages

### Stage 0: Update Existing n8n Workflow

**Tasks:**
- Replace Chat Trigger with Webhook Trigger node
- Update AI Agent prompt to work with webhook payload structure (`{{ $json.body.message }}`)
- Update Gmail node to include webhook URL fields (firstName, lastName, email, url)
- Add HTTP Request node to send enriched data back to app
- Configure HTTP Request with proper JSON body (use `JSON.stringify()` for strings, not booleans)

**Deliverable:** n8n workflow accepts webhooks and sends enriched data back

---

### Stage 1: Create Server Action for Feedback Submission

**File:** `src/app/actions/feedback.ts`

**Tasks:**
- Accept form data (message only)
- Extract user info from Clerk session:
  - `userId` from `auth().userId`
  - `firstName`, `lastName`, `email` from `clerkClient().users.getUser(userId)`
- Get browser info from headers (`user-agent`)
- Get current timestamp (ISO 8601)
- Get current URL from headers (`referer` or construct from request)
- Validate required fields (message is required; userId optional)
- Call n8n webhook with complete payload (matching structure above)
- Handle errors gracefully with try/catch
- Return success/error response

**Environment Variable:** `N8N_FEEDBACK_WEBHOOK_URL`

**Deliverable:** Server Action sends feedback to n8n webhook

---

### Stage 2: Create Webhook Endpoint to Receive Processed Data

**File:** `src/app/api/webhooks/n8n/feedback/route.ts`

**Tasks:**
- Export async POST handler
- Parse JSON body from request
- Validate payload structure (check all required fields exist)
- Log received data for debugging
- Insert feedback into Supabase `feedback` table
- Return JSON response: `{success: true, message: "Feedback stored"}`
- Handle errors and return appropriate status codes

**Deliverable:** API endpoint receives and stores processed feedback

---

### Stage 3: Create Supabase Feedback Table

**File:** `supabase/migrations/YYYYMMDDHHMMSS_feedback_table.sql`

**Tasks:**
- Create migration file for `feedback` table
- Define schema with all columns (matching schema above)
- Add RLS policies:
  - Users can INSERT their own feedback (`user_id = auth.jwt()->>'sub'` OR `user_id IS NULL`)
  - Admins can SELECT all feedback (future: check for admin role)
  - No UPDATE or DELETE permissions
- Test migration locally

**Deliverable:** Supabase table ready to store feedback

---

### Stage 4: Update Feedback Modal Component

**File:** `src/components/feedback-modal.tsx`

**Tasks:**
- Import Server Action (`submitFeedback`)
- Call it on form submit with message field
- Show loading state while submitting
- Show success message after submission
- Show error message if submission fails
- Close modal after successful submission (2 second delay)

**Deliverable:** Feedback form connected to Server Action

---

### Stage 5: Test End-to-End with Vercel Preview

**Tasks:**
- Commit and push code to trigger preview deployment
- Get preview URL from Vercel dashboard
- Update n8n HTTP Request node callback URL to preview URL + `/api/webhooks/n8n/feedback`
- Add `N8N_FEEDBACK_WEBHOOK_URL` to Vercel environment variables (Preview and Production)
- Submit test feedback via preview app
- Verify complete data flow:
  1. Form → Server Action → n8n webhook
  2. n8n → AI Agent → enriched data
  3. n8n → Gmail → notification email received
  4. n8n → App webhook → Supabase storage
- Check Vercel logs for webhook callback
- Check Supabase table for stored feedback with AI analysis

**Deliverable:** Complete end-to-end flow tested and working

---

## Success Criteria

- ✅ User can submit feedback from any page
- ✅ Feedback is processed by AI within 5 seconds
- ✅ Email notification received with structured AI analysis
- ✅ Data stored in Supabase with all fields populated (including sentiment, category, priority)
- ✅ No data loss
- ✅ Graceful error handling with user-friendly messages
- ✅ Workflow works identically on preview and production deployments

---

## Future Enhancements

- **Webhook Security (lesson 5.5):** Add signature verification and rate limiting
- **Admin Dashboard:** View all feedback with filtering by sentiment, category, priority
- **Feedback Analytics:** Track trends over time, sentiment distribution
- **Auto-tagging:** Create Linear/GitHub issues for high-priority bugs
- **User Notifications:** Notify users when their feedback is addressed

---

## References

- **n8n Setup:** `src/docs/n8n-setup.md`
- **Feedback Schemas:** `src/lib/schemas/feedback.ts`
- **Supabase Setup:** `src/docs/supabase-setup.md`
- **Integrations:** `src/docs/INTEGRATIONS.md`
